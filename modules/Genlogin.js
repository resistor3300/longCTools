let o=require("axios"),b=require("os"),E=require("path"),T=require("fs").promises,{log:x,json:k}=require("./logger"),$=require("puppeteer-extra"),e=require("puppeteer-extra-plugin-stealth"),s=($.use(e()),"http://localhost:55550/backend/profiles");class t{constructor(e,t=!1){this.api_key=e,this.debug=t,this.vendor="genlogin"}async getProfile(e){e=s+"/"+e;return await o.get(e).then(e=>e.data.data).catch(e=>e.response.data)}async getProfiles(e=0,t=1e3){var a=s;try{var r=await o.get(a+`?limit=${t}&offset=`+e);return{profiles:r.data.data.items,pagination:r.data.data.pagination}}catch(e){"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code?x("[getProfiles]: Không thể kết nối đến Genlogin. Vui lòng kiểm tra xem Genlogin đã được mở chưa.",this.vendor):x("[getProfiles]: Lỗi khi lấy danh sách profiles: "+e.message,this.vendor)}}async getListProfiles(e=0,t=1e3,a=1e4){var r=s,i=new Promise((e,t)=>setTimeout(()=>t(new Error("Request timed out")),a));try{var n=await Promise.race([o.get(r+`?limit=${t}&offset=`+e),i]);return{profiles:n.data.data.items.map((e,t)=>({id:t,user_id:e.user_id,status:e.status,idbrower:e.id,pid:e.profile_data.name+"-"+e.id,browser_version:e.profile_data.browser_version,proxy:e.profile_data.proxy,vendor:this.vendor,updated:(new Date).toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(",","")})),pagination:n.data.data.pagination}}catch(e){return"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code?x("[getListProfiles] : Không thể kết nối đến Genlogin. Vui lòng kiểm tra xem Genlogin đã được mở chưa.",this.vendor,!1):x("[getListProfiles]: Lỗi khi lấy danh sách profiles: "+e.message,this.vendor,!1),null}}async getWsEndpoint(e){e=s+`/${e}/ws-endpoint`;return await o.get(e).then(e=>e.data).catch(e=>e.response.data)}async runProfile(e){let t=await this.getWsEndpoint(e);var a;return t?.data?.wsEndpoint?(x(`[runProfile]: WebSocket endpoint found for profile ${e}: `+t.data.wsEndpoint,this.vendor),{success:!0,...t.data}):(x("[runProfile]: No valid WebSocket endpoint found for profile "+e,this.vendor,!1),a=s+`/${e}/start`,(a=await o.put(a).then(e=>e.data).catch(e=>e.response.data)).wsEndpoint?(x(`[runProfile]: Profile ${e} started successfully. wsEndpoint: `+a.wsEndpoint,this.vendor),{success:!0,wsEndpoint:a.wsEndpoint}):(x(`[runProfile]: Profile ${e} đang chạy trên thiết bị khác, hoặc chưa mở`,this.vendor,"w"),{success:!1,message:"Profile is running on another device"}))}async connectWs(a,e,t,r=2e4){try{x(`[connectWs]: screens:${e.screens}|screenWidthHeight:`+e.screenWidthHeight,this.vendor,"w");var i=new Promise(async(e,t)=>{try{e(await $.connect({browserWSEndpoint:a,headless:!1,defaultViewport:null,ignoreHTTPSErrors:!0,args:["--disable-web-security","--disable-features=IsolateOrigins","--disable-site-isolation-trials","--disable-features=BlockInsecurePrivateNetworkRequests","--no-sandbox","--disable-setuid-sandbox","--disable-popup-blocking"]}))}catch(e){t(e)}}),n=new Promise((e,t)=>{setTimeout(()=>{t(new Error(`[connectWs]: Timeout of ${r}ms exceeded`))},r)});return await Promise.race([i,n])}catch(e){return x("[connectWs]: Error occurred - "+e.message,this.vendor,!1),!1}}async connect(f,P,e,a=2e4){let y;try{let h=e.scale,m=e.width,w=e.height,g=Math.ceil(e.x/h/h),v=Math.ceil(e.y/h/h),p;var t=new Promise(async(e,t)=>{try{x("[connect]: genDataFolder:"+k(f),this.vendor,"w");var a=E.join(f.genDataFolder,"profiles",String(P.user_id)),r=await this.findDirectory(a,String(P.user_id)+"_"+String(P.idbrower)),i=`C:\\Users\\${b.userInfo().username}\\.genlogin\\browsers\\titan\\${P.browser_version}\\chrome.exe`,n=E.join(f.genDataFolder,"extensions.json"),o=(x("[connect]:extPath:"+n,this.vendor,"w"),await T.readFile(n,"utf8")),s=await(await JSON.parse(o)).filter(e=>!e.disabled).map(e=>e.path),l=(p=await s.join(","),x("[connect]Đường dẫn các extension được bật: "+p,null,"w"),E.join(r,"custom_device.json")),c=(x("[connect]:configPath:"+l,this.vendor,"w"),await T.readFile(l,"utf8")),u=(await JSON.parse(c)).navigator.userAgent,d=(x("[connect]: "+r,this.vendor,"w"),x("[connect]: "+i,this.vendor,"w"),x(`[connect]: ${g}x${v}|scaleFactor;${h}|${m}x`+w,this.vendor,"w"),["--user-agent="+u,"--mute-audio","--disable-web-security","--disable-features=IsolateOrigins","--disable-site-isolation-trials","--disable-features=BlockInsecurePrivateNetworkRequests","--no-sandbox","--disable-setuid-sandbox","--disable-popup-blocking",`--window-size=${m},`+w,`--window-position=${g},`+v,"--force-device-scale-factor="+h,"--disable-blink-features=AutomationControlled","--disable-notifications","--load-extension="+p,"--disable-extensions-except="+p]);x("[connect]: "+d,this.vendor,"w"),(y=await $.launch({headless:!1,executablePath:i,defaultViewport:null,ignoreHTTPSErrors:!0,args:d,userDataDir:r})).on("targetcreated",async e=>{e=e.url();e.startsWith("chrome-extension://")&&x("Extension được tải: "+e,null,"c")}),e(y)}catch(e){t(e)}}),r=new Promise((e,t)=>{setTimeout(()=>{t(new Error(`[connect]: Timeout of ${a}ms exceeded`))},a)});return await Promise.race([t,r])}catch(e){return x("[connect]: Error occurred - "+e.message,this.vendor,!1),y.close(),!1}}async findDirectory(e,t){try{var a;for(a of await T.readdir(e,{withFileTypes:!0}))if(a.isDirectory()&&a.name.includes(t))return E.join(e,a.name)}catch(e){x("[findDirectory]Error accessing directory: "+e.message,null,!1)}return null}async stopProfile(e){var t=s+`/${e}/stop`,t=await o.put(t).then(e=>e.data).catch(e=>e.response.data);return x("[stopProfile]: Stopped profile "+e,this.vendor),t}async getProfilesRunning(){var e=s+"/running",e=await o.get(e).then(e=>e.data).catch(e=>e.response.data);return e.success?e.data:(x("[getProfilesRunning]: Failed to fetch running profiles",this.vendor),[])}async checkProfileIsRun(e){var t=await this.getProfilesRunning();let a=parseInt(e,10);t=t.find(e=>e.id===a);return t?(x(`[checkProfileIsRun]: Profile ${e} is running. wsEndpoint: `+t.wsEndpoint,this.vendor),{success:!0,wsEndpoint:t.wsEndpoint}):{success:!1,message:`Profile ${e} is not running.`}}async setEmulatePage(e,t,a,r){try{return await t.setViewport({width:parseInt(a[0]),height:parseInt(a[1]),deviceScaleFactor:r}),x(`[setEmulatePage]: ${parseInt(a[0])}x${parseInt(a[1])}|scale:`+r,this.vendor,"w"),t}catch(e){return x("[setEmulatePage]: Error: "+e.message,this.vendor,!1),null}}async getCurrentPage0(e){try{var t,a=await(await e.pages()).filter(e=>!e.isClosed());return 0===a.length?(x("[getCurrentPage]: No active pages found",this.vendor,!1),null):(t=await a[a.length-1])?(x("[getCurrentPage]: Active page found with URL: "+await t.url(),this.vendor),t):(x("[getCurrentPage]: No active page found after filtering",this.vendor,!1),null)}catch(e){return x("[getCurrentPage]: Error getting current page: "+e.message,this.vendor,!1),null}}async getCurrentPage(e){try{var t=await e.pages();for(let e=0;e<t.length;e++){var a,r=await t[e].url(),i=await t[e].title();if("visible"===await t[e].evaluate(()=>document.visibilityState)&&!r.startsWith("devtools://"))return a=new URL(r),x(`[getCurrentPage]: ${e+1} |${a.hostname}|`+i,null,"w"),t[e]}return x("[getCurrentPage]: Không tìm thấy page nào đang focus hoặc hợp lệ.",null,!1),null}catch(e){return console.error("[getCurrentPage]: Lỗi khi tìm tab đang được focus:",e),null}}async elementExistsByXPath(e,t,a=3e4){try{return await e.waitForSelector("xpath/"+t,{timeout:a}),x(`[elementExistsByXPath]: Element with XPath "${t}" exists`),!0}catch(e){return"TimeoutError"===e.name?x(`[elementExistsByXPath]: Timeout ${a} waiting for element with XPath "${t}"`,this.vendor,!1):x("[elementExistsByXPath]: Error: "+e.message,this.vendor),null}}async click(a,r){try{if(r.xpath){let t=await r.browser.targets();await a.waitForFunction(e=>null!==document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,{timeout:r.timeout||3e4},r.xpath);var i=await a.evaluateHandle(e=>document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,r.xpath);if(i){r.tagClick?(x("[click]: TagClick Mode",this.vendor,"w"),await a.evaluate(async(e,t)=>{e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),await new Promise(e=>setTimeout(e,200)),t.dbclick&&(e.click(),await new Promise(e=>setTimeout(e,100))),e.click()},i,r)):await a.evaluate(e=>{e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},i),await new Promise(e=>setTimeout(e,1e3));var n=await i.boundingBox();if(n){r.tagClick||(x("[click]: simulator move Mode",this.vendor,"w"),{x:o,y:s,width:l,height:c}=n,u=o+l/2,d=s+c/2,await r.mainframe.mouse.move(u,d,{steps:10}),await new Promise(e=>setTimeout(e,Math.floor(100*Math.random())+50)),r.dbclick?await r.mainframe.mouse.click(u,d,{clickCount:2}):await r.mainframe.mouse.click(u,d));var o,s,l,c,u,d,h=await a.evaluate(a=>new Promise(r=>{let t=new MutationObserver((e,t)=>{for(var a of e)"childList"!==a.type&&"attributes"!==a.type||(t.disconnect(),r(!0));r(!1)});if(t.observe(document.body,{attributes:!0,childList:!0,subtree:!0}),"input"===a.tagName.toLowerCase())a.focus(),r(document.activeElement===a);else{let e=a.innerHTML;setTimeout(()=>{t.disconnect(),r(a.innerHTML!==e)},1e3)}}),i),m=await a.evaluate(e=>new Promise(i=>{let n=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(n){let a=n.className,r=new MutationObserver(e=>{for(var t of e)if("attributes"===t.type&&"class"===t.attributeName&&n.className!==a)return r.disconnect(),void i(!0)});r.observe(n,{attributes:!0}),setTimeout(()=>{r.disconnect(),i(!1)},2e3)}else i(!1)}),r.xpath);let e;var w=await(await r.browser.targets()).find(e=>!t.includes(e));return e=w?(x("[click]: A new tab opened with URL "+w.url(),this.vendor,"i"),!0):(x("[click]: Không mở tab mới ra "+k(w),this.vendor,"i"),!1),h||e||m?(x("[click]: XPath click thành công",this.vendor),!0):(x("[click]: XPath click không thành công "+r.xpath,this.vendor,!1),!1)}x("[click]: Không thể xác định XPath: "+r.xpath,this.vendor,!1)}else x("[click]: Không tìm thấy phần tử với XPath: "+r.xpath,this.vendor,!1);return!1}return void 0!==r.x&&void 0!==r.y?(await r.mainframe.mouse.click(r.x,r.y),x(`click: Đã click tại tọa độ (${r.x}, ${r.y})`,this.vendor),!0):(x("click: Khoản chọn click không hợp lệ. Vui lòng cung cấp xpath hoặc tọa độ x và y.",this.vendor),!1)}catch(e){return x(`[click]: Lỗi trong quá trình thực hiện click ${r.xpath} : `+e.message,this.vendor,!1),!1}}async getTextByXPath(e,t,a=3e4){var r=await this.getElementByXPath(e,t),i=new Promise(e=>setTimeout(()=>e(null),a));try{var n,o=await Promise.race([r,i]);if(o)return n=await e.evaluate(e=>e.textContent.trim(),o),x("[getTextByXPath]: Fetched text: "+n),n}catch(e){return x("[getTextByXPath]:Error fetching text: "+e.message,this.vendor,!1),null}return x("[getTextByXPath]:Element not found with XPath: "+t,this.vendor,!1),null}async getElementByXPath(e,t,a=3e4){try{await e.waitForSelector("xpath/"+t,{timeout:a});var r=await e.$$("xpath/"+t,e=>e.outerHTML);return r.length?r[0]:null}catch(e){return x("[getElementByXPath]: Error getting element by XPath: "+e.message,this.vendor),null}}async getHtmlByXPath(e,t,a=3e4){var e=e.evaluate(e=>{e=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return e?e.outerHTML:null},t),r=new Promise(e=>setTimeout(()=>e(null),a));try{var i=await Promise.race([e,r]);return i?(x("[getHtmlByXPath]: Successfully retrieved HTML for XPath: "+t,this.vendor),i):(x("[getHtmlByXPath]: Element not found or timeout occurred for XPath: "+t,this.vendor),null)}catch(e){return x("[getHtmlByXPath]: Error getting element by XPath: "+e.message,this.vendor),null}}async getAttributeFromXPath(e,t,a,r=3e4){var i=this.getElementByXPath(e,t),n=new Promise(e=>setTimeout(()=>e(null),r));try{var o=await Promise.race([i,n]);if(o)return await e.evaluate((e,t)=>e.getAttribute(t),o,a)}catch(e){return x("[getAttributeFromXPath]: Error fetching attribute: "+e.message,this.vendor,!1),null}return x("[getAttributeFromXPath]: Element not found with XPath: "+t,this.vendor,!1),null}async switchFrame(r,t,i=3e4){var e=new Promise(e=>setTimeout(()=>e(null),i)),a=(async()=>{if("mainframe"===t)return await r.bringToFront(),r;if(""!=t){var e=await this.getAttributeFromXPath(r,t,"src",i);if(e){let t=new URL(e);await r.frames();var a=await r.waitForFrame(e=>{try{return new URL(e.url()).hostname.endsWith(t.hostname.split(".").slice(-2).join("."))}catch{return!1}},{timeout:5e3});return a?(x("[switchFrame]: Switched to subframe",this.vendor),a):(x("[switchFrame]: Subframe not found with URL: "+e,this.vendor,!1),null)}x("[switchFrame]: Failed to get frame URL",this.vendor,!1)}else x("[switchFrame]: Failed to get frame XPath",this.vendor,!1);return null})();return Promise.race([a,e])}async clickAndHold(e,t,a=1e3,r=3e4){let i=null;if(t.xpath&&!(i=await this.getElementByXPath(e,t.xpath,r)))return x("[clickAndHold]: Element not found with XPath: "+t.xpath,this.vendor),!1;try{var n,o,s,l,c;return i?(n=await i.boundingBox())?(o=n.x+n.width/2,s=n.y+n.height/2,await t.mainframe.mouse.move(o,s),await t.mainframe.mouse.down(),await new Promise(e=>setTimeout(e,a)),await t.mainframe.mouse.up(),x("[clickAndHold]: Clicked and hold on element with XPath: "+t.xpath,this.vendor),!0):(x("[clickAndHold]: Bounding box not found for element with XPath: "+t.xpath,this.vendor,!1),!1):t.points?({x:l,y:c}=t.points,await t.mainframe.mouse.move(l,c),await t.mainframe.mouse.down(),await new Promise(e=>setTimeout(e,a)),await t.mainframe.mouse.up(),x(`[clickAndHold]: Clicked and held at coordinates (${l}, ${c})`,this.vendor),!0):(x("[clickAndHold]: No valid target specified (XPath or points)",this.vendor),!1)}catch(e){return x("[clickAndHold]: Error during click and hold: "+e.message,this.vendor),!1}}async scroll(e,{xpath:t,points:a,direction:r="down",speed:i=1},n=3e4){let o=null;if(t&&!(o=await this.getElementByXPath(e,t,n)))return x("[scroll]: Element not found with XPath: "+t,this.vendor),!1;try{var s,l,c,u;return o?(await e.evaluate(e=>{e.scrollIntoView({behavior:"smooth",block:"center"})},o),x("[scroll]: Scrolled to element with XPath: "+t,this.vendor),!0):a?({x:s,y:l}=a,c="down"===r?100:-100,u=100/i,await e.evaluate(async({x:t,y:a,scrollAmount:r,scrollInterval:i})=>{for(let e=0;e<Math.abs(r);e+=10)window.scrollBy(t,a+(0<r?10:-10)),await new Promise(e=>setTimeout(e,i))},{x:s,y:l,scrollAmount:c,scrollInterval:u}),x(`[scroll]: Scrolled ${r} at coordinates (${s}, ${l}) with speed `+i,this.vendor),!0):(x("[scroll]: No valid target specified (XPath or coordinates)",this.vendor),!1)}catch(e){return x("[scroll]: Error during scroll: "+e.message,this.vendor),!1}}async swipe(a,{xpath:e,direction:r="down",distance:i=200,speed:n=1},t=3e4){let o=null;if(e&&!(o=await this.getElementByXPath(a,e,t)))return console.log("[swipe]: Element not found with XPath: "+e),!1;try{if(o){var s=await o.boundingBox(),l=s.x+s.width/2,c=s.y+s.height/2;let e=l,t="down"===r?c+i:c-i;return"left"!==r&&"right"!==r||(e="right"===r?l+i:l-i,t=c),await a.mouse.move(l,c),await a.mouse.down(),await a.mouse.move(e,t,{steps:n}),await a.mouse.up(),console.log(`[swipe]: Swiped ${r} from (${l}, ${c}) to (${e}, ${t}) with distance ${i} and speed `+n),!0}return console.log("[swipe]: No valid target specified (XPath)"),!1}catch(e){return console.log("[swipe]: Error during swipe: "+e.message),!1}}async typeText(a,e,r,i=1,t=3e4){var n=100/i;let o=.8*n,s=1.2*n;var n=(async()=>{try{for(var e of r){var t=Math.random()*(s-o)+o;await a.keyboard.type(e,{delay:t})}return x(`[typeText]: Đã gõ thành công chuỗi "${r}" với tốc độ `+i,this.vendor),!0}catch(e){return x("[typeText]: Lỗi khi gõ văn bản: "+e.message,this.vendor),!1}})(),l=new Promise(e=>setTimeout(()=>e(!1),t));return Promise.race([n,l])}async selectDropdown(e,t,a,r=3e4){try{var i=await this.getElementByXPath(e,t,r);return i?(await i.select(a),x(`[selectDropdown]: Selected value "${a}" in dropdown with XPath "${t}"`,this.vendor),!0):(x("[selectDropdown]: Element not found with XPath: "+t,this.vendor),!1)}catch(e){return x("[selectDropdown]: Error selecting value: "+e.message,this.vendor),!1}}async javascript(e,t,...a){try{return await e.evaluate((e,...t)=>{new Function(...t.map((e,t)=>"arg"+t),e)(...t)},t,...a),x("[javascript]: Executed script",this.vendor),!0}catch(e){return x("[javascript]: Error executing script: "+e.message,this.vendor,!1),!1}}async sleep(e,t=null,a=3e4){let r;r=null!==t?Math.random()*(t-e)*1e3+1e3*e:1e3*e;t=new Promise(e=>setTimeout(e,r)),e=new Promise(e=>setTimeout(()=>e("timeout"),a));return"timeout"===await Promise.race([t,e])?(x(`[sleep]: Timeout of ${a}ms exceeded`,this.vendor),!1):(x(`[sleep]: Slept for ${r/1e3}s`,this.vendor),!0)}async random(a,r,t=3e4){var e=new Promise(e=>{var t=Math.random()*(r-a)+a;e(Math.floor(t))}),i=new Promise(e=>setTimeout(()=>e("timeout"),t)),e=await Promise.race([e,i]);return"timeout"===e?(x(`[random]: Timeout of ${t}ms exceeded`,this.vendor),!1):(x(`[random]: Generated random value ${e} in range [${a}, ${r}]`,this.vendor),e)}async activateTab(e,t,a,r){try{var i=a.split("x"),n=await e.pages();return t<0||t>=n.length?(x("[activateTab]: Invalid tab index "+t,this.vendor),null):(await n[t].bringToFront(),x("[activateTab]: Activated tab at index "+t,this.vendor),await this.setEmulatePage(e,n[t],i,r))}catch(e){return x("[activateTab]: Error activating tab: "+e.message,this.vendor),null}}async closeTab(e,a=null,r=3e4){try{let t=await e.pages();var i=(async()=>{var e;return null===a?(e=await t.find(e=>!1===e.isClosed()))?(await e.close(),x("[closeTab]: Closed current tab",this.vendor),!0):(x("[closeTab]: No current tab to close",this.vendor),null):a<0||a>=t.length?(x("[closeTab]: Invalid tab index "+a,this.vendor),null):(await t[a].close(),x("[closeTab]: Closed tab at index "+a,this.vendor),!0)})(),n=await new Promise(e=>setTimeout(()=>e("timeout"),r)),o=await Promise.race([i,n]);return"timeout"===o?(x(`[closeTab]: Timeout of ${r}ms exceeded`,this.vendor),null):o}catch(e){return x("[closeTab]: Error closing tab: "+e.message,this.vendor),null}}async countOpenTabs(e,a=5e3){var t=new Promise((e,t)=>setTimeout(()=>t(new Error("Timeout while counting tabs")),a));try{var r=await e.pages(),i=(await Promise.race([r,t])).length;return x("[countOpenTabs]: Số tab đang được mở: "+i,this.vendor,"w"),i}catch(e){return x("[countOpenTabs]: Lỗi trong quá trình đếm số tab: "+e.message,this.vendor,!1),0}}async newTab(a,r=3e4){try{var e,i,n=a.newPage(),o=new Promise(e=>setTimeout(()=>e("timeout"),r));if("timeout"===await Promise.race([n,o]))return x(`[newTab]: Timeout of ${r}ms exceeded`,this.vendor),!1;let t=!1;for(let e=0;e<30;e++){if(1<(await a.pages()).length){t=!0;break}await new Promise(e=>setTimeout(e,100))}return t?(i=(e=await a.pages()).length-1,x(`[newTab]: Opened and activated a new tab totaltab: ${e.length} tabindex: `+i,this.vendor),i):(x("[newTab]: Failed to open new tab within timeout",this.vendor),!1)}catch(e){return x("[newTab]: Error opening new tab: "+e.message,this.vendor),!1}}async goBack(e,t=3e4){try{var a=e.goBack(),r=new Promise(e=>setTimeout(()=>e("timeout"),t));return"timeout"===await Promise.race([a,r])?(x(`[goBack]: Timeout of ${t}ms exceeded`,this.vendor),!1):(x("[goBack]: Navigated back to the previous page",this.vendor),!0)}catch(e){return x("[goBack]: Error navigating back: "+e.message,this.vendor),!1}}async reloadPage(e,t=3e4,a="load"){try{var r=e.reload({timeout:t,waitUntil:a}),i=new Promise(e=>setTimeout(()=>e("timeout"),t));return"timeout"===await Promise.race([r,i])?(x(`[reloadPage]: Timeout of ${t}ms exceeded`,this.vendor),!1):(x("[reloadPage]: Reloaded the page with waitUntil: "+a,this.vendor),!0)}catch(e){return x("[reloadPage]: Error reloading page: "+e.message,this.vendor),!1}}async openUrl(e,t,a=3e4,r="load"){try{var i=e.goto(t,{timeout:a,waitUntil:r}),n=new Promise(e=>setTimeout(()=>e("timeout"),a));return"timeout"===await Promise.race([i,n])?(x(`[openUrl]: Timeout of ${a}ms exceeded`,this.vendor),!1):(x(`[openUrl]: Opened URL ${t} with waitUntil: `+r,this.vendor),!0)}catch(e){return x(`[openUrl]: Error opening URL ${t}: `+e.message,this.vendor),!1}}async countXpath(e,t,a=3e4){var r=new Promise((e,t)=>{setTimeout(()=>t(new Error("Timeout")),a)}),e=e.evaluate(e=>document.evaluate(e,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null).snapshotLength,t);try{var i=await Promise.race([e,r]);return parseInt(i)}catch(e){throw new Error("[countXpath]: Lỗi xảy ra - "+e.message)}}async autoCloseDialog(i,n=2e4){try{let t=new Set,a=async e=>{if(!t.has(e))return x("[autoCloseDialog]: Closing dialog with message: "+e.message(),this.vendor),await e.dismiss(),t.add(e),!0},r=async e=>{if("alert"===e.type()&&!t.has(e))return x("[autoCloseDialog]: Closing alert with message: "+e.message(),this.vendor),await e.dismiss(),t.add(e),!0};if(i.on("dialog",a),i.on("dialog",r),"timeout"===await new Promise(e=>setTimeout(()=>{i.off("dialog",a),i.off("dialog",r),e("timeout")},n)))return x(`[autoCloseDialog]: Timeout of ${n}ms exceeded`,this.vendor),!1}catch(e){return x("[autoCloseDialog]: Error occurred - "+e.message,this.vendor),!1}}async nowTime(){var e=new Date,[t,a]=e.toLocaleString("en-GB",{timeZone:"Asia/Ho_Chi_Minh",hour12:!1}).split(", "),[t,r,i]=t.split("/");return{date:t+`-${r}-${i} `+a,timestamp:e.getTime()/1e3}}async tinhThoiGian(e){var e=1e3*(await this.nowTime()).timestamp-1e3*e,e=Math.floor(e/1e3),t=Math.floor(e/60),a=t%60,e=e%60;return`${Math.floor(t/60).toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:`+e.toString().padStart(2,"0")}}module.exports=t;