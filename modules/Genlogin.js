import s from"axios";import T from"os";import x from"path";import{promises as E}from"fs";import{log as k,json as $}from"./logger.js";import X from"puppeteer-extra";import e from"puppeteer-extra-plugin-stealth";X.use(e());let l="http://localhost:55550/backend/profiles";class t{constructor(e,t=!1){this.api_key=e,this.debug=t,this.vendor="gen"}async getProfile(e=0,t){t=l+"/"+t;return await s.get(t).then(e=>e.data.data).catch(e=>e.response.data)}async getProfiles(t="",e=0,a=1e3){var r=l;try{var i=await s.get(r+`?limit=${a}&offset=`+e);return{profiles:i.data.data.items,pagination:i.data.data.pagination}}catch(e){"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code?k(t,"[getProfiles]: Không thể kết nối đến Genlogin. Vui lòng kiểm tra xem Genlogin đã được mở chưa.",this.vendor,!1):k(t,"[getProfiles]: Lỗi khi lấy danh sách profiles: "+e.message,this.vendor,!1)}}async getListProfiles(t="",e=0,a=1e3,r=1e4){var i=l,n=new Promise((e,t)=>setTimeout(()=>t(new Error("Request timed out")),r));try{var o=await Promise.race([s.get(i+`?limit=${a}&offset=`+e),n]);return{profiles:o.data.data.items.map((e,t)=>({id:t,user_id:e.user_id,status:e.status,idbrower:e.id,pid:e.profile_data.name+"-"+e.id,browser_version:e.profile_data.browser_version,vendor:this.vendor,updated:(new Date).toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(",","")})),pagination:o.data.data.pagination}}catch(e){return"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code?k(t,"[getListProfiles] : Không thể kết nối đến Genlogin",this.vendor,!1):k(t,"[getListProfiles]: Lỗi khi lấy danh sách profiles: "+e.message,this.vendor,!1),null}}async getWsEndpoint(e=0,t){t=l+`/${t}/ws-endpoint`;return await s.get(t).then(e=>e.data).catch(e=>e.response.data)}async runProfile(e="",t){let a=await this.getWsEndpoint(e,t);var r;return a?.data?.wsEndpoint?(k(e,`[runProfile]: WebSocket endpoint found for profile ${t}: `+a.data.wsEndpoint,this.vendor),{success:!0,...a.data}):(k(e,"[runProfile]: No valid WebSocket endpoint found for profile "+t,this.vendor,!1),r=l+`/${t}/start`,(r=await s.put(r).then(e=>e.data).catch(e=>e.response.data)).wsEndpoint?(k(e,`[runProfile]: Profile ${t} started successfully. wsEndpoint: `+r.wsEndpoint,this.vendor),{success:!0,wsEndpoint:r.wsEndpoint}):(k(e,`[runProfile]: Profile ${t} đang chạy trên thiết bị khác, hoặc chưa mở`,this.vendor,"w"),{success:!1,message:"Profile is running on another device"}))}async connectWs(t="",a,e,r,i=2e4){try{k(t,`[connectWs]: screens:${e.screens}|screenWidthHeight:`+e.screenWidthHeight,this.vendor,"w");var n=new Promise(async(e,t)=>{try{e(await X.connect({browserWSEndpoint:a,headless:!1,defaultViewport:null,ignoreHTTPSErrors:!0,args:["--disable-web-security","--disable-features=IsolateOrigins","--disable-site-isolation-trials","--disable-features=BlockInsecurePrivateNetworkRequests","--no-sandbox","--disable-setuid-sandbox","--disable-popup-blocking"]}))}catch(e){t(e)}}),o=new Promise((e,t)=>{setTimeout(()=>{t(new Error(`[connectWs]: Timeout of ${i}ms exceeded`))},i)});return await Promise.race([n,o])}catch(e){return k(t,"[connectWs]: Error occurred - "+e.message,this.vendor,!1),!1}}async connect(f="",y,P,e,a=2e4){let b;try{let d=e.scale,m=e.width,g=e.height,w=Math.ceil(e.x/d),v=Math.ceil(e.y/d),p;var t=new Promise(async(e,t)=>{try{k(f,"[connect]: GenDataProfile:"+$(P),this.vendor,"w"),k(f,"[connect]: genDataFolder:"+$(y),this.vendor,"w");var a=x.join(y.genDataFolder,"profiles",String(P.user_id)),r=await this.findDirectory(f,a,String(P.user_id)+"_"+String(P.idbrower)),i=`C:\\Users\\${T.userInfo().username}\\.genlogin\\browsers\\titan\\${P.browser_version}\\chrome.exe`,n=x.join(y.genDataFolder,"extensions.json"),o=(k(f,"[connect]:extPath:"+n,this.vendor,"w"),await E.readFile(n,"utf8")),s=await(await JSON.parse(o)).filter(e=>!e.disabled).map(e=>e.path),l=(p=await s.join(","),k(f,"[connect]Đường dẫn các extension được bật: "+p,null,"w"),x.join(r,"custom_device.json")),c=(k(f,"[connect]:configPath:"+l,this.vendor,"w"),await E.readFile(l,"utf8")),u=(await JSON.parse(c)).navigator.userAgent,h=(k(f,"[connect]: "+r,this.vendor,"w"),k(f,"[connect]: "+i,this.vendor,"w"),k(f,`[connect]: ${w}x${v}|scaleFactor;${d}|${m}x`+g,this.vendor,"w"),["--user-agent="+u,"--mute-audio","--disable-web-security","--disable-features=IsolateOrigins","--disable-site-isolation-trials","--disable-features=BlockInsecurePrivateNetworkRequests","--no-sandbox","--disable-setuid-sandbox","--disable-popup-blocking",`--window-size=${m},`+g,`--window-position=${w},`+v,"--force-device-scale-factor="+d,"--disable-blink-features=AutomationControlled","--disable-notifications","--load-extension="+p,"--disable-extensions-except="+p]);k(f,"[connect]: "+h,this.vendor,"w"),(b=await X.launch({headless:!1,executablePath:i,defaultViewport:null,ignoreHTTPSErrors:!0,args:h,userDataDir:r})).on("targetcreated",async e=>{e=e.url();e.startsWith("chrome-extension://")&&k(f,"Extension được tải: "+e,null,"c")}),e(b)}catch(e){t(e)}}),r=new Promise((e,t)=>{setTimeout(()=>{t(new Error(`[connect]: Timeout of ${a}ms exceeded`))},a)});return await Promise.race([t,r])}catch(e){return k(f,"[connect]: Error occurred - "+e.message,this.vendor,!1),b.close(),!1}}async findDirectory(t="",e,a){try{var r;for(r of await E.readdir(e,{withFileTypes:!0}))if(r.isDirectory()&&r.name.includes(a))return x.join(e,r.name)}catch(e){k(t,"[findDirectory]Error accessing directory: "+e.message,this.vendor,!1)}return null}async stopProfile(e="",t){var a=l+`/${t}/stop`,a=await s.put(a).then(e=>e.data).catch(e=>e.response.data);return k(e,"[stopProfile]: Stopped profile "+t,this.vendor),a}async getProfilesRunning(e=""){var t=l+"/running",t=await s.get(t).then(e=>e.data).catch(e=>e.response.data);return t.success?t.data:(k(e,"[getProfilesRunning]: Failed to fetch running profiles",this.vendor),[])}async checkProfileIsRun(e="",t){var a=await this.getProfilesRunning(e);let r=parseInt(t,10);a=a.find(e=>e.id===r);return a?(k(e,`[checkProfileIsRun]: Profile ${t} is running. wsEndpoint: `+a.wsEndpoint,this.vendor),{success:!0,wsEndpoint:a.wsEndpoint}):{success:!1,message:`Profile ${t} is not running.`}}async setEmulatePage(t="",e,a,r,i){try{return k(t,`[setEmulatePage]: ${parseInt(r[0])}x${parseInt(r[1])}|scale:`+i,this.vendor,"w","s"),a}catch(e){return k(t,"[setEmulatePage]: Error: "+e.message,this.vendor,!1),null}}async setTitle(t="",e,a,r=5e3){try{await Promise.race([e.evaluate(e=>{document.title=e},a),new Promise((e,t)=>setTimeout(()=>t(new Error("Timeout exceeded")),r))]);return k(t,`[setTitle]: đăt title: ${a} ok`,this.vendor,"i"),!0}catch(e){return k(t,"[setTitle]: Error: "+e.message,this.vendor,!1),null}}async getCurrentPage0(t="",e){try{var a,r=await(await e.pages()).filter(e=>!e.isClosed());return 0===r.length?(k(t,"[getCurrentPage]: No active pages found",this.vendor,!1),null):(a=await r[r.length-1])?(k(t,"[getCurrentPage]: Active page found with URL: "+await a.url(),this.vendor),a):(k(t,"[getCurrentPage]: No active page found after filtering",this.vendor,!1),null)}catch(e){return k(t,"[getCurrentPage]: Error getting current page: "+e.message,this.vendor,!1),null}}async getCurrentPage(t="",e){try{var a=await e.pages();for(let e=0;e<a.length;e++){var r,i=await a[e].url(),n=await a[e].title();if("visible"===await a[e].evaluate(()=>document.visibilityState)&&!i.startsWith("devtools://"))return r=new URL(i),k(t,`[getCurrentPage]: ${e+1} |${r.hostname}|`+n,null,"w"),a[e]}return k(t,"[getCurrentPage]: Không tìm thấy page nào đang focus hoặc hợp lệ.",null,!1),null}catch(e){return k(t,"[getCurrentPage]: Lỗi khi tìm tab đang được focus: "+e.message,this.vendor,!1),null}}async elementExistsByXPath(t="",e,a,r=3e4){try{return await e.waitForSelector("xpath/"+a,{timeout:r}),k(t,`[elementExistsByXPath]: Element with XPath "${a}" exists`),!0}catch(e){return"TimeoutError"===e.name?k(t,`[elementExistsByXPath]: Timeout ${r} waiting for element with XPath "${a}"`,this.vendor,!1):k(t,"[elementExistsByXPath]: Error: "+e.message,this.vendor,!1),null}}async click(a="",r,i){try{if(i.xpath){let t=await i.browser.targets();await r.waitForFunction(e=>null!==document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,{timeout:i.timeout||3e4},i.xpath);var n=await r.evaluateHandle(e=>document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,i.xpath);if(n){i.tagClick?(k(a,"[click]: TagClick Mode",this.vendor,"w"),await r.evaluate(async(e,t)=>{e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),await new Promise(e=>setTimeout(e,200)),t.dbclick&&(e.click(),await new Promise(e=>setTimeout(e,100))),e.click()},n,i)):await r.evaluate(e=>{e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},n),await new Promise(e=>setTimeout(e,1e3));var o=await n.boundingBox();if(o){i.tagClick||(k(a,"[click]: simulator move Mode",this.vendor,"w"),{x:s,y:l,width:c,height:u}=o,h=s+c/2,d=l+u/2,await i.mainframe.mouse.move(h,d,{steps:10}),await new Promise(e=>setTimeout(e,Math.floor(100*Math.random())+50)),i.dbclick?await i.mainframe.mouse.click(h,d,{clickCount:2}):await i.mainframe.mouse.click(h,d));var s,l,c,u,h,d,m=await r.evaluate(a=>new Promise(r=>{let t=new MutationObserver((e,t)=>{for(var a of e)"childList"!==a.type&&"attributes"!==a.type||(t.disconnect(),r(!0));r(!1)});if(t.observe(document.body,{attributes:!0,childList:!0,subtree:!0}),"input"===a.tagName.toLowerCase())a.focus(),r(document.activeElement===a);else{let e=a.innerHTML;setTimeout(()=>{t.disconnect(),r(a.innerHTML!==e)},1e3)}}),n),g=await r.evaluate(e=>new Promise(i=>{let n=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(n){let a=n.className,r=new MutationObserver(e=>{for(var t of e)if("attributes"===t.type&&"class"===t.attributeName&&n.className!==a)return r.disconnect(),void i(!0)});r.observe(n,{attributes:!0}),setTimeout(()=>{r.disconnect(),i(!1)},2e3)}else i(!1)}),i.xpath);let e;var w=await(await i.browser.targets()).find(e=>!t.includes(e));return e=w?(k(a,"[click]: A new tab opened with URL "+w.url(),this.vendor,"i"),!0):(k(a,"[click]: Không mở tab mới ra "+$(w),this.vendor,"i"),!1),m||e||g?(k(a,"[click]: XPath click thành công",this.vendor),!0):(k(a,"[click]: XPath click không thành công "+i.xpath,this.vendor,!1),!1)}k(a,"[click]: Không thể xác định XPath: "+i.xpath,this.vendor,!1)}else k(a,"[click]: Không tìm thấy phần tử với XPath: "+i.xpath,this.vendor,!1);return!1}return void 0!==i.x&&void 0!==i.y?(await i.mainframe.mouse.move(i.x,i.y,{steps:500}),await i.mainframe.mouse.click(i.x,i.y),k(a,`click: Đã click tại tọa độ (${i.x}, ${i.y})`,this.vendor),!0):(k(a,"click: Khoản chọn click không hợp lệ. Vui lòng cung cấp xpath hoặc tọa độ x và y.",this.vendor),!1)}catch(e){return k(a,`[click]: Lỗi trong quá trình thực hiện click ${i.xpath} : `+e.message,this.vendor,!1),!1}}async getTextByXPath(t="",e,a,r=3e4){var i=await this.getElementByXPath(t,e,a,3e3),n=new Promise(e=>setTimeout(()=>e(null),r));try{var o,s=await Promise.race([i,n]);if(s)return o=await e.evaluate(e=>e.textContent.trim(),s),k(t,"[getTextByXPath]: Fetched text: "+o),o}catch(e){return k(t,"[getTextByXPath]:Error fetching text: "+e.message,this.vendor,!1),null}return k(t,"[getTextByXPath]:Element not found with XPath: "+a,this.vendor,!1),null}async getAllTextByXPath(t="",a,e,r=3e4){try{var i,n=await Promise.race([a.$$("xpath/"+e),new Promise(e=>setTimeout(()=>e(null),r))]);return n&&0!==n.length?(i=await Promise.all(n.map(async e=>a.evaluate(e=>e.textContent.trim(),e))),k(t,"[getAllTextByXPath]: Found texts: "+JSON.stringify(i)),i):(k(t,"[getAllTextByXPath]: No elements found with XPath: "+e,this.vendor,!1),[])}catch(e){return k(t,"[getAllTextByXPath]: Error fetching texts: "+e.message,this.vendor,!1),[]}}async getElementByXPath(t="",e,a,r=3e4){try{await e.waitForSelector("xpath/"+a,{timeout:r});var i=await e.$$("xpath/"+a,e=>e.outerHTML);return i.length?i[0]:null}catch(e){return k(t,"[getElementByXPath]: Error getting element by XPath: "+e.message,this.vendor,!1),null}}async getHtmlByXPath(t="",e,a,r=3e4){var e=e.evaluate(e=>{e=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return e?e.outerHTML:null},a),i=new Promise(e=>setTimeout(()=>e(null),r));try{var n=await Promise.race([e,i]);return n?(k(t,"[getHtmlByXPath]: Successfully retrieved HTML for XPath: "+a,this.vendor),n):(k(t,"[getHtmlByXPath]: Element not found or timeout occurred for XPath: "+a,this.vendor),null)}catch(e){return k(t,"[getHtmlByXPath]: Error getting element by XPath: "+e.message,this.vendor,!1),null}}async getAttributeFromXPath(t="",e,a,r,i=3e4){var n=await this.getElementByXPath(t,e,a,3e3),o=new Promise(e=>setTimeout(()=>e(null),i));try{var s=await Promise.race([n,o]);if(s)return await e.evaluate((e,t)=>e.getAttribute(t),s,r)}catch(e){return k(t,"[getAttributeFromXPath]: Error fetching attribute: "+e.message,this.vendor,!1),null}return k(t,"[getAttributeFromXPath]: Element not found with XPath: "+a,this.vendor,!1),null}async switchFrame(r="",i,t,n=3e4){var e=new Promise(e=>setTimeout(()=>e(null),n)),a=(async()=>{if("mainframe"===t)return await i.bringToFront(),i;if(""!=t){var e=await this.getAttributeFromXPath(r,i,t,"src",n);if(e){let t=new URL(e);await i.frames();var a=await i.waitForFrame(e=>{try{return new URL(e.url()).hostname.endsWith(t.hostname.split(".").slice(-2).join("."))}catch{return!1}},{timeout:5e3});return a?(k(r,"[switchFrame]: Switched to subframe",this.vendor,!0),a):(k(r,"[switchFrame]: Subframe not found with URL: "+e,this.vendor,!1),null)}k(r,"[switchFrame]: Failed to get frame URL",this.vendor,!1)}else k(r,"[switchFrame]: Failed to get frame XPath",this.vendor,!1);return null})();return Promise.race([a,e])}async clickAndHold(t="",e,a,r=1e3,i=3e4){let n=null;if(k(t,"[clickAndHold]: vào clickAndHold",this.vendor,"i"),a.xpath&&!(n=await this.getElementByXPath(t,e,a.xpath,i,3e3)))return k(t,"[clickAndHold]: Element not found with XPath: "+a.xpath,this.vendor),!1;try{var o,s,l,c,u;return n?(o=await n.boundingBox())?(s=o.x+o.width/2,l=o.y+o.height/2,await a.mainframe.mouse.move(s,l),await a.mainframe.mouse.down(),await new Promise(e=>setTimeout(e,r)),await a.mainframe.mouse.up(),k(t,"[clickAndHold]: Clicked and hold on element with XPath: "+a.xpath,this.vendor),!0):(k(t,"[clickAndHold]: Bounding box not found for element with XPath: "+a.xpath,this.vendor,!1),!1):a.points?({x:c,y:u}=a.points,await a.mainframe.mouse.move(c,u),await a.mainframe.mouse.down(),await new Promise(e=>setTimeout(e,r)),await a.mainframe.mouse.up(),k(t,`[clickAndHold]: Clicked and held at coordinates (${c}, ${u})`,this.vendor),!0):(k(t,"[clickAndHold]: No valid target specified (XPath or points)",this.vendor),!1)}catch(e){return k(t,"[clickAndHold]: Error during click and hold: "+e.message,this.vendor,!1),!1}}async centerPoint(t="",e,a=3e4){try{k(t,"[centerPoint] Bắt đầu lấy tọa độ trung tâm của trang...");var r,i,n=e.evaluate(()=>{var e=document.documentElement;return{width:e.scrollWidth,height:e.scrollHeight}}),o=new Promise((e,t)=>setTimeout(()=>t("Timeout"),a)),s=await Promise.race([n,o]);if(s&&s.width&&s.height)return r=s.width/2,k(t,`[centerPoint] Tọa độ trung tâm: X = ${r}, Y = `+(i=s.height/2)),{x:r,y:i};throw new Error("Không thể lấy kích thước của trang")}catch(e){return k(t,"[centerPoint] Lỗi: "+e.message,this.vendor,!1),null}}async xpathPoint(t="",e,a,r=3e4){try{k(t,"[xpathPoint] Bắt đầu lấy tọa độ xpath...");var i,n=await e.waitForSelector(`::-p-xpath(${a})`,{timeout:r});return n?{x:(i=await n.boundingBox()).x+i.width/2,y:i.y+i.height/2,width:i.width,height:i.height}:null}catch(e){return k(t,"[xpathPoint] Lỗi: "+e.message,this.vendor,!1),null}}async moveMouseZigzag(t="",a,e,r,i,n,o=3e4,s=100){var l=Date.now();try{k(t,"Bắt đầu di chuyển chuột theo zigzag...",this.vendor,!0);for(var c=e-i/2,u=e+i/2,h=r-n/2,d=r+n/2,m=(await a.mouse.move(e,r),n/s);Date.now()-l<o;)for(let e=0;e<=s;e++){var g=e%2==0?c:u,w=h+m*e;if(w<=d&&await a.mouse.move(g,w),Date.now()-l>=o)return k(t,"Timeout reached, dừng di chuyển chuột zigzag.",this.vendor,!1),!1}return k(t,"Hoàn thành di chuyển zigzag trong thời gian cho phép.",this.vendor,!0),!0}catch(e){return k(t,"Lỗi: "+e.message,this.vendor,!1),!1}}async moveMouseSpiral(t="",a,e,r,i,n=3e4,o=100,s=null){var l=Date.now();try{for(k(t,"Bắt đầu di chuyển chuột theo spiral...",this.vendor,!0),await a.mouse.move(e,r);Date.now()-l<n;){if(s?.aborted)return k(t,"dừng di chuyển chuột spiral Bị huỷ bởi AbortController.",this.vendor,!1),!1;var c=e+Math.floor(100*Math.random())-50,u=r+Math.floor(100*Math.random())-50;for(let e=0;e<o;e++){var h=e/o*Math.PI*4,d=i*e/o,m=c+d*Math.cos(h),g=u+d*Math.sin(h);if(await a.mouse.move(m,g),Date.now()-l>=n)return k(t,"Timeout reached, dừng di chuyển chuột spiral.",this.vendor,!1),!1}}return k(t,"Hoàn thành di chuyển spiral trong thời gian cho phép.",this.vendor,!0),!0}catch(e){return k(t,"Lỗi: "+e.message,this.vendor,!1),!1}}async scroll(t="",e,{xpath:a,points:r,direction:i="down",speed:n=1},o=3e4){let s=null;if(a&&!(s=await this.getElementByXPath(t,e,a,o,3e3)))return k(t,"[scroll]: Element not found with XPath: "+a,this.vendor),!1;try{var l,c,u,h;return s?(await e.evaluate(e=>{e.scrollIntoView({behavior:"smooth",block:"center"})},s),k(t,"[scroll]: Scrolled to element with XPath: "+a,this.vendor),!0):r?({x:l,y:c}=r,u="down"===i?100:-100,h=100/n,await e.evaluate(async({x:t,y:a,scrollAmount:r,scrollInterval:i})=>{for(let e=0;e<Math.abs(r);e+=10)window.scrollBy(t,a+(0<r?10:-10)),await new Promise(e=>setTimeout(e,i))},{x:l,y:c,scrollAmount:u,scrollInterval:h}),k(t,`[scroll]: Scrolled ${i} at coordinates (${l}, ${c}) with speed `+n,this.vendor),!0):(k(t,"[scroll]: No valid target specified (XPath or coordinates)",this.vendor),!1)}catch(e){return k(t,"[scroll]: Error during scroll: "+e.message,this.vendor,!1),!1}}async swipe(t="",a,{xpath:e,direction:r="down",distance:i=200,speed:n=1},o=3e4){let s=null;if(e&&!(s=await this.getElementByXPath(t,a,e,o,3e3)))return console.log("[swipe]: Element not found with XPath: "+e),!1;try{if(s){var l=await s.boundingBox(),c=l.x+l.width/2,u=l.y+l.height/2;let e=c,t="down"===r?u+i:u-i;return"left"!==r&&"right"!==r||(e="right"===r?c+i:c-i,t=u),await a.mouse.move(c,u),await a.mouse.down(),await a.mouse.move(e,t,{steps:n}),await a.mouse.up(),console.log(`[swipe]: Swiped ${r} from (${c}, ${u}) to (${e}, ${t}) with distance ${i} and speed `+n),!0}return console.log("[swipe]: No valid target specified (XPath)"),!1}catch(e){return k(t,"[swipe]: Error during swipe: "+e.message,this.vendor,!1),!1}}async typeText(a="",r,e,i,n=1,t=3e4){var o=100/n;let s=.8*o,l=1.2*o;var o=(async()=>{try{for(var e of i){var t=Math.random()*(l-s)+s;await r.keyboard.type(e,{delay:t})}return k(a,`[typeText]: Đã gõ thành công chuỗi "${i}" với tốc độ `+n,this.vendor),!0}catch(e){return k(a,"[typeText]: Lỗi khi gõ văn bản: "+e.message,this.vendor,!1),!1}})(),c=new Promise(e=>setTimeout(()=>e(!1),t));return Promise.race([o,c])}async selectDropdown(t="",e,a,r,i=3e4){try{var n=await this.getElementByXPath(t,e,a,i,3e3);return n?(await n.select(r),k(t,`[selectDropdown]: Selected value "${r}" in dropdown with XPath "${a}"`,this.vendor),!0):(k(t,"[selectDropdown]: Element not found with XPath: "+a,this.vendor),!1)}catch(e){return k(t,"[selectDropdown]: Error selecting value: "+e.message,this.vendor,!1),!1}}async javascript(t="",e,a,...r){try{return await e.evaluate((e,...t)=>{new Function(...t.map((e,t)=>"arg"+t),e)(...t)},a,...r),k(t,"[javascript]: Executed script",this.vendor,!0),!0}catch(e){return k(t,"[javascript]: Error executing script: "+e.message,this.vendor,!1),!1}}async sleep(e="",t,a=null,r=3e4){let i;i=null!==a?Math.random()*(a-t)*1e3+1e3*t:1e3*t;a=new Promise(e=>setTimeout(e,i)),t=new Promise(e=>setTimeout(()=>e("timeout"),r));return"timeout"===await Promise.race([a,t])?(k(e,`[sleep]: Timeout of ${r}ms exceeded`,this.vendor),!1):(k(e,`[sleep]: Slept for ${i/1e3}s`,this.vendor),!0)}async random(e="",a,r,t=3e4){var i=new Promise(e=>{var t=Math.random()*(r-a)+a;e(Math.floor(t))}),n=new Promise(e=>setTimeout(()=>e("timeout"),t)),i=await Promise.race([i,n]);return"timeout"===i?(k(e,`[random]: Timeout of ${t}ms exceeded`,this.vendor),!1):(k(e,`[random]: Generated random value ${i} in range [${a}, ${r}]`,this.vendor),i)}async activateTab(t="",e,a,r,i){try{var n=r.split("x"),o=await e.pages();return a<0||a>=o.length?(k(t,"[activateTab]: Invalid tab index "+a,this.vendor,!1),null):(await o[a].bringToFront(),k(t,"[activateTab]: Activated tab at index "+a,this.vendor),await this.setEmulatePage(t,e,o[a],n,i))}catch(e){return k(t,"[activateTab]: Error activating tab: "+e.message,this.vendor,!1),null}}async closeTab(a="",e,r=null,i=3e4){try{let t=await e.pages();var n=(async()=>{var e;return null===r?(e=await t.find(e=>!1===e.isClosed()))?(await e.close(),k(a,"[closeTab]: Closed current tab",this.vendor),!0):(k(a,"[closeTab]: No current tab to close",this.vendor),null):r<0||r>=t.length?(k(a,"[closeTab]: Invalid tab index "+r,this.vendor),null):(await t[r].close(),k(a,"[closeTab]: Closed tab at index "+r,this.vendor),!0)})(),o=await new Promise(e=>setTimeout(()=>e("timeout"),i)),s=await Promise.race([n,o]);return"timeout"===s?(k(a,`[closeTab]: Timeout of ${i}ms exceeded`,this.vendor),null):s}catch(e){return k(a,"[closeTab]: Error closing tab: "+e.message,this.vendor,!1),null}}async countOpenTabs(t="",e,a=5e3){var r=new Promise((e,t)=>setTimeout(()=>t(new Error("Timeout while counting tabs")),a));try{var i=await e.pages(),n=(await Promise.race([i,r])).length;return k(t,"[countOpenTabs]: Số tab đang được mở: "+n,this.vendor,"w"),n}catch(e){return k(t,"[countOpenTabs]: Lỗi trong quá trình đếm số tab: "+e.message,this.vendor,!1),0}}async newTab(a="",r,i=3e4){try{var e,n,o=r.newPage(),s=new Promise(e=>setTimeout(()=>e("timeout"),i));if("timeout"===await Promise.race([o,s]))return k(a,`[newTab]: Timeout of ${i}ms exceeded`,this.vendor),!1;let t=!1;for(let e=0;e<30;e++){if(1<(await r.pages()).length){t=!0;break}await new Promise(e=>setTimeout(e,100))}return t?(n=(e=await r.pages()).length-1,k(a,`[newTab]: Opened and activated a new tab totaltab: ${e.length} tabindex: `+n,this.vendor),n):(k(a,"[newTab]: Failed to open new tab within timeout",this.vendor),!1)}catch(e){return k(a,"[newTab]: Error opening new tab: "+e.message,this.vendor,!1),!1}}async goBack(t="",e,a=3e4){try{var r=e.goBack(),i=new Promise(e=>setTimeout(()=>e("timeout"),a));return"timeout"===await Promise.race([r,i])?(k(t,`[goBack]: Timeout of ${a}ms exceeded`,this.vendor),!1):(k(t,"[goBack]: Navigated back to the previous page",this.vendor),!0)}catch(e){return k(t,"[goBack]: Error navigating back: "+e.message,this.vendor,!1),!1}}async reloadPage(t="",e,a=3e4,r="load"){try{var i=e.reload({timeout:a,waitUntil:r}),n=new Promise(e=>setTimeout(()=>e("timeout"),a));return"timeout"===await Promise.race([i,n])?(k(t,`[reloadPage]: Timeout of ${a}ms exceeded`,this.vendor),!1):(k(t,"[reloadPage]: Reloaded the page with waitUntil: "+r,this.vendor),!0)}catch(e){return k(t,"[reloadPage]: Error reloading page: "+e.message,this.vendor,!1),!1}}async openUrl(t="",e,a,r=3e4,i="load"){try{var n=e.goto(a,{timeout:r,waitUntil:i}),o=new Promise(e=>setTimeout(()=>e("timeout"),r));return"timeout"===await Promise.race([n,o])?(k(t,`[openUrl]: Timeout of ${r}ms exceeded`,this.vendor,!1),!1):(k(t,`[openUrl]: Opened URL ${a} with waitUntil: `+i,this.vendor),!0)}catch(e){return k(t,`[openUrl]: Error opening URL ${a}: `+e.message,this.vendor,!1),!1}}async countXpath(e=0,t,a,r=3e4){var i=new Promise((e,t)=>{setTimeout(()=>t(new Error("Timeout")),r)}),t=t.evaluate(e=>document.evaluate(e,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null).snapshotLength,a);try{var n=await Promise.race([t,i]);return parseInt(n)}catch(e){throw new Error("[countXpath]: Lỗi xảy ra - "+e.message)}}async autoCloseDialog(i="",n,o=2e4){try{let t=new Set,a=async e=>{if(!t.has(e))return k(i,"[autoCloseDialog]: Closing dialog with message: "+e.message(),this.vendor),await e.dismiss(),t.add(e),!0},r=async e=>{if("alert"===e.type()&&!t.has(e))return k(i,"[autoCloseDialog]: Closing alert with message: "+e.message(),this.vendor),await e.dismiss(),t.add(e),!0};if(n.on("dialog",a),n.on("dialog",r),"timeout"===await new Promise(e=>setTimeout(()=>{n.off("dialog",a),n.off("dialog",r),e("timeout")},o)))return k(i,`[autoCloseDialog]: Timeout of ${o}ms exceeded`,this.vendor),!1}catch(e){return k(i,"[autoCloseDialog]: Error occurred - "+e.message,this.vendor,!1),!1}}async nowTime(e=0){var t=new Date,[a,r]=t.toLocaleString("en-GB",{timeZone:"Asia/Ho_Chi_Minh",hour12:!1}).split(", "),[a,i,n]=a.split("/");return{date:a+`-${i}-${n} `+r,timestamp:t.getTime()/1e3}}async tinhThoiGian(e){var e=1e3*(await this.nowTime()).timestamp-1e3*e,e=Math.floor(e/1e3),t=Math.floor(e/60),a=t%60,e=e%60;return`${Math.floor(t/60).toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:`+e.toString().padStart(2,"0")}}export default t;